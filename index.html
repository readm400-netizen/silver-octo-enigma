<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rojgar Point</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary: #4F46E5; --bg: #F8FAFC; --card: #ffffff; --text: #1F2937; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 90px; height: 100vh; overflow-y: scroll; }

        /* HEADER */
        .header { background: var(--card); padding: 20px 20px 15px 20px; border-radius: 0 0 25px 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); position: relative; z-index: 10; }
        
        .user-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .user-info h3 { margin: 0; font-size: 1.1rem; line-height: 1.2; }
        
        .card-id-box { 
            background: #EEF2FF; color: var(--primary); padding: 5px 10px; border-radius: 8px; 
            font-size: 0.85rem; display: inline-flex; align-items: center; gap: 6px; cursor: pointer;
            margin-top: 4px; border: 1px dashed #4F46E5; font-weight: 500;
        }

        /* DIGITAL CARD */
        .balance-card {
            background: linear-gradient(135deg, #1e1e2f 0%, #2d2d44 100%);
            border-radius: 16px; padding: 20px; color: white; position: relative;
            overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .card-chip { width: 40px; height: 28px; background: linear-gradient(135deg, #FFD700, #FDB931); border-radius: 6px; margin-bottom: 10px; }
        .card-bal { font-size: 1.8rem; font-weight: 700; letter-spacing: 0.5px; margin: 5px 0; }
        .card-num { font-family: monospace; letter-spacing: 2px; opacity: 0.7; font-size: 1rem; }

        /* TABS */
        .cat-wrapper { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-top: 5px; scrollbar-width: none; }
        .cat-tab { padding: 8px 16px; background: #fff; border: 1px solid #e2e8f0; border-radius: 20px; white-space: nowrap; font-size: 0.85rem; color: #666; transition: 0.3s; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .cat-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .cat-tab img { width: 16px; height: 16px; border-radius: 50%; }

        /* PAGES */
        .page { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }

        /* TASK CARD FIXED */
        .task-card { 
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; 
            display: flex; align-items: center; justify-content: space-between; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #f1f5f9;
        }
        .task-left { display: flex; align-items: center; gap: 12px; }
        .task-icon { 
            width: 42px; height: 42px; background: #EEF2FF; color: var(--primary); 
            border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; 
        }
        .btn-start { 
            padding: 8px 16px; background: #EEF2FF; color: var(--primary); 
            border-radius: 8px; font-weight: 600; font-size: 0.8rem; border: none; cursor: pointer; 
        }

        /* REFER PAGE FIX */
        .refer-box {
            text-align: center; background: white; padding: 25px 20px; border-radius: 16px; margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .link-box {
            background: #F8FAFC; border: 1px dashed #CBD5E1; padding: 12px; border-radius: 8px; 
            margin: 15px 0; font-family: monospace; font-size: 0.9rem; color: #475569;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer;
        }

        /* WALLET & INPUTS */
        .pay-opt { flex: 1; padding: 12px; background: white; border: 1px solid #ddd; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
        .pay-opt.active { border: 2px solid var(--primary); background: #EEF2FF; color: var(--primary); font-weight: bold; }
        
        .w-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 12px; outline: none; font-size: 0.95rem; }
        .action-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; }
        .btn-transfer { background: #10B981; }

        /* NAV */
        .nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #eee; z-index: 1000; padding-bottom: 15px; }
        .nav-item { text-align: center; color: #94A3B8; font-size: 0.7rem; width: 25%; }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-item i { font-size: 1.3rem; display: block; margin-bottom: 4px; }

        /* ADMIN BTN */
        .admin-fab { position: fixed; bottom: 90px; right: 20px; width: 50px; height: 50px; background: #E11D48; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(225, 29, 72, 0.4); z-index: 9999; cursor: pointer; }
        
        /* LOGIN & LOADER */
        #login-screen, #loader { position: fixed; inset: 0; background: white; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div id="login-screen" style="display:none;">
        <h2 style="margin-bottom: 10px;">Welcome Back</h2>
        <p style="color:#64748B; margin-bottom:20px;">Enter your username to continue</p>
        <input type="text" id="login-user" class="w-input" placeholder="@username" style="max-width: 300px;">
        <button class="action-btn" onclick="manualLogin()" style="max-width: 300px;">Login Now</button>
    </div>

    <div class="admin-fab" id="admin-btn" onclick="window.location.href='admin.html'">
        <i class="fas fa-user-shield" style="font-size: 1.2rem;"></i>
    </div>

    <div class="header">
        <div class="user-top">
            <div style="display:flex; align-items:center; gap:12px;">
                <div style="width:45px; height:45px; background:#E2E8F0; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:1.2rem; color:#475569;" id="u-av">?</div>
                <div class="user-info">
                    <h3 id="u-name">Guest</h3>
                    <div class="card-id-box" onclick="copyCardID()">
                        <i class="far fa-credit-card"></i> <span id="u-card-id">...</span> <i class="fas fa-copy" style="font-size:0.7rem;"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="balance-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="card-chip"></div>
                <i class="fas fa-wifi" style="opacity: 0.7;"></i>
            </div>
            <div style="font-size:0.75rem; opacity:0.8; letter-spacing:1px; margin-top:5px;">TOTAL BALANCE</div>
            <div class="card-bal">à§³<span id="u-bal">0.00</span></div>
            <div class="card-num" id="card-display">**** **** ****</div>
        </div>

        <div class="cat-wrapper" id="cat-tabs"></div>
    </div>

    <div id="p-tasks" class="page active">
        <h4 style="margin: 10px 0 15px 0; color: #475569; font-size:0.95rem;">Task List</h4>
        <div id="task-container" style="padding-bottom: 20px;">
            <p style="text-align:center; color:#94A3B8; margin-top:30px;">Loading tasks...</p>
        </div>
    </div>

    <div id="p-wallet" class="page">
        <div style="background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.02);">
            <h4 style="margin:0 0 15px 0; color:#1E293B;"><i class="fas fa-university" style="color:var(--primary); margin-right:5px;"></i> Withdraw</h4>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <div class="pay-opt" onclick="setPay('Bkash', this)">Bkash</div>
                <div class="pay-opt" onclick="setPay('Nagad', this)">Nagad</div>
            </div>

            <input type="number" id="w-num" class="w-input" placeholder="Wallet Number">
            <input type="number" id="w-amt" class="w-input" placeholder="Amount">
            <button class="action-btn" onclick="withdraw()">Request Withdraw</button>
            <div style="margin-top: 10px; font-size: 0.8rem; color: #64748B; background: #F1F5F9; padding: 8px; border-radius: 6px; text-align:center;" id="w-rules">Loading rules...</div>
        </div>

        <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.02);">
            <h4 style="margin:0 0 15px 0; color:#1E293B;"><i class="fas fa-paper-plane" style="color: #10B981; margin-right:5px;"></i> P2P Transfer</h4>
            
            <input type="number" id="t-card" class="w-input" placeholder="Receiver Card ID (10 digits)">
            <input type="number" id="t-amt" class="w-input" placeholder="Amount to Send">
            <button class="action-btn btn-transfer" onclick="transferMoney()">Send Money</button>
        </div>
        <div style="height: 50px;"></div>
    </div>

    <div id="p-refer" class="page">
        <div class="refer-box">
            <img src="https://cdn-icons-png.flaticon.com/512/3893/3893069.png" width="60" style="margin-bottom:10px;">
            <h2 style="margin: 0; font-size:1.5rem;">Refer & Earn</h2>
            <p style="color: #64748B; font-size: 0.85rem; margin-top:5px;" id="ref-bonus-msg">Invite friends now!</p>
            
            <div class="link-box" id="ref-link-display" onclick="copyRef()">Loading Link...</div>
            <input type="text" id="ref-link-real" style="position:fixed; left:-9999px;" readonly>
            
            <button class="action-btn" onclick="copyRef()" style="padding:10px;">Copy Link</button>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <div style="flex:1; background: white; padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                <h3 id="ref-count" style="margin:0;">0</h3>
                <small style="color: #64748B; font-size:0.75rem;">Total Joins</small>
            </div>
            <div style="flex:1; background: white; padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                <h3 style="margin:0; color: #10B981;">à§³<span id="ref-earn">0</span></h3>
                <small style="color: #64748B; font-size:0.75rem;">Total Earned</small>
            </div>
        </div>
    </div>

    <div id="p-profile" class="page">
        <h3 style="margin-bottom: 20px;">Profile</h3>
        <div style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.02);">
            <div style="padding: 15px; border-bottom: 1px solid #F1F5F9; display: flex; justify-content: space-between; align-items:center;" onclick="copyCardID()">
                <span style="font-size:0.95rem; color:#334155;"><i class="far fa-credit-card" style="margin-right:10px; color:#94A3B8;"></i> My Card ID</span>
                <span style="font-weight:600; color:var(--primary); font-size:0.9rem;" id="profile-card-id">...</span>
            </div>
            <div style="padding: 15px; border-bottom: 1px solid #F1F5F9; cursor:pointer;" onclick="editName()">
                <span style="font-size:0.95rem; color:#334155;"><i class="fas fa-pen" style="margin-right:10px; color:#94A3B8;"></i> Edit Name</span>
            </div>
            <div style="padding: 15px; border-bottom: 1px solid #F1F5F9; cursor:pointer;" onclick="openSupport()">
                <span style="font-size:0.95rem; color:#334155;"><i class="fas fa-headset" style="margin-right:10px; color:#94A3B8;"></i> Support</span>
            </div>
            <div style="padding: 15px; cursor:pointer; color: #EF4444;" onclick="logout()">
                <span style="font-size:0.95rem;"><i class="fas fa-sign-out-alt" style="margin-right:10px;"></i> Logout</span>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="nav('p-tasks', this)"><i class="fas fa-home"></i>Home</div>
        <div class="nav-item" onclick="nav('p-wallet', this)"><i class="fas fa-wallet"></i>Wallet</div>
        <div class="nav-item" onclick="nav('p-refer', this)"><i class="fas fa-users"></i>Refer</div>
        <div class="nav-item" onclick="nav('p-profile', this)"><i class="fas fa-user"></i>Profile</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAxRuQsi36v3uT-IRXqbls4OBA9PVddqiM",
            authDomain: "telegram-mini-apps-2cc3c.firebaseapp.com",
            databaseURL: "https://telegram-mini-apps-2cc3c-default-rtdb.firebaseio.com",
            projectId: "telegram-mini-apps-2cc3c",
            storageBucket: "telegram-mini-apps-2cc3c.firebasestorage.app",
            messagingSenderId: "819238200908",
            appId: "1:819238200908:web:3f97d8de37d8b46c0936e9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        const ADMIN_ID = "8391024974"; 
        const BOT_USERNAME = "Rojgar_Point_bot";
        const BOT_TOKEN = "8280244541:AAE8SP9L9QzfBXIEBVatzLQdV9nNjpEhcV8";

        let user = null, settings = {}, activeCat = 'all', payMethod = '';

        window.tg = window.Telegram.WebApp;
        window.tg.expand();

        async function init() {
            let uid = null;
            let name = "Guest";
            let refBy = null;

            if (window.tg.initDataUnsafe && window.tg.initDataUnsafe.user) {
                const u = window.tg.initDataUnsafe.user;
                uid = u.id.toString();
                name = u.first_name;
                refBy = window.tg.initDataUnsafe.start_param;
            } else {
                uid = localStorage.getItem('web_uid');
            }

            if (uid) {
                loginUser(uid, name, refBy);
            } else {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
            }
        }

        window.manualLogin = function() {
            const input = document.getElementById('login-user').value;
            if(!input) return Swal.fire('Error', 'Enter username', 'error');
            const uid = "web_" + input.replace(/[^a-zA-Z0-9]/g, '').toLowerCase(); 
            localStorage.setItem('web_uid', uid);
            loginUser(uid, input, null);
        }

        async function loginUser(uid, name, refBy) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('loader').style.display = 'flex';
            
            const uRef = ref(db, 'users/' + uid);
            onValue(uRef, (snap) => {
                if(snap.exists()) {
                    user = snap.val();
                    // Generate Card ID if missing
                    if(!user.cardID) {
                        const newCardID = Math.floor(1000000000 + Math.random() * 9000000000).toString();
                        update(uRef, { cardID: newCardID });
                        user.cardID = newCardID;
                    }
                    updateUI();
                } else {
                    // New User
                    const newCardID = Math.floor(1000000000 + Math.random() * 9000000000).toString();
                    user = { id: uid, name: name, balance: 0, refCount: 0, refEarn: 0, cardID: newCardID, completed: {} };
                    
                    if(refBy && refBy !== uid) {
                         get(ref(db, 'users/'+refBy)).then(rSnap => {
                             if(rSnap.exists()) {
                                 get(ref(db, 'settings')).then(sSnap => {
                                     const bonus = sSnap.exists() ? (sSnap.val().referBonus || 0) : 0;
                                     update(ref(db, 'users/'+refBy), {
                                         balance: parseFloat(rSnap.val().balance) + parseFloat(bonus),
                                         refCount: (rSnap.val().refCount || 0) + 1,
                                         refEarn: (rSnap.val().refEarn || 0) + parseFloat(bonus)
                                     });
                                     fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_ID}&text=New Refer: ${name}`);
                                 });
                             }
                         });
                    }
                    set(uRef, user);
                    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_ID}&text=New User: ${name} (ID: ${uid})`);
                }
                document.getElementById('loader').style.display = 'none';
            });
            loadData();
        }

        function updateUI() {
            document.getElementById('u-name').innerText = user.name;
            document.getElementById('u-av').innerText = user.name.charAt(0);
            document.getElementById('u-bal').innerText = parseFloat(user.balance).toFixed(2);
            
            // Refer Link Fix
            const link = `https://t.me/${BOT_USERNAME}?start=${user.id}`;
            document.getElementById('ref-link-display').innerText = link;
            document.getElementById('ref-link-real').value = link;
            
            document.getElementById('ref-count').innerText = user.refCount || 0;
            document.getElementById('ref-earn').innerText = parseFloat(user.refEarn || 0).toFixed(2);
            
            // Card Display Fix
            const formattedCard = user.cardID ? user.cardID.match(/.{1,4}/g).join(' ') : ".... ....";
            document.getElementById('u-card-id').innerText = user.cardID || "...";
            document.getElementById('card-display').innerText = formattedCard;
            document.getElementById('profile-card-id').innerText = user.cardID;

            if(String(user.id) === String(ADMIN_ID)) document.getElementById('admin-btn').style.display = 'flex';
        }

        function loadData() {
            onValue(ref(db, 'settings'), snap => {
                if(snap.exists()) {
                    settings = snap.val();
                    const popKey = 'pop_' + new Date().getDate();
                    if(settings.popupMsg && !sessionStorage.getItem(popKey)) {
                         Swal.fire({ title: 'ðŸ“¢ Notice', text: settings.popupMsg, confirmButtonColor: '#4F46E5' });
                         sessionStorage.setItem(popKey, 'true');
                    }
                    document.getElementById('w-rules').innerText = `Min: à§³${settings.minWithdraw} | Refer: ${settings.minRefer}`;
                    document.getElementById('ref-bonus-msg').innerText = `Earn à§³${settings.referBonus} per invite!`;
                }
            });

            onValue(ref(db, 'categories'), snap => {
                const tabs = document.getElementById('cat-tabs');
                tabs.innerHTML = `<div class="cat-tab active" onclick="setCat('all', this)">All</div>`;
                if(snap.exists()) {
                    const cats = snap.val();
                    Object.keys(cats).forEach(key => {
                        const c = cats[key];
                        let icon = c.icon.includes('http') ? `<img src="${c.icon}">` : `<i class="${c.icon}"></i>`;
                        tabs.innerHTML += `<div class="cat-tab" onclick="setCat('${key}', this)">${icon} ${c.name}</div>`;
                    });
                }
            });

            onValue(ref(db, 'tasks'), snap => {
                const list = document.getElementById('task-container');
                list.innerHTML = '';
                let count = 0;
                const completed = user && user.completed ? user.completed : {};
                
                if(snap.exists()) {
                    const tasks = snap.val();
                    Object.keys(tasks).forEach(key => {
                        const t = tasks[key];
                        if((activeCat === 'all' || t.category === activeCat) && !completed[key]) {
                            count++;
                            list.innerHTML += `
                            <div class="task-card">
                                <div class="task-left">
                                    <div class="task-icon"><i class="fas fa-star"></i></div>
                                    <div>
                                        <div style="font-weight:600; font-size:0.95rem;">${t.title}</div>
                                        <small style="color:#4F46E5;">+à§³${t.reward}</small>
                                    </div>
                                </div>
                                <button class="btn-start" onclick="doTask('${key}', ${t.reward}, '${t.link}')">Start</button>
                            </div>`;
                        }
                    });
                }
                if(count === 0) list.innerHTML = "<p style='text-align:center;color:#94A3B8;margin-top:30px;'>No tasks available</p>";
            });
        }

        window.setCat = function(cat, el) {
            activeCat = cat;
            document.querySelectorAll('.cat-tab').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            // Force re-render tasks by re-reading from DB cache (simplified)
            get(ref(db, 'tasks')).then(snap => { 
                // Logic is inside onValue listener, so we just trigger it or reload?
                // Actually, the simplest way without reloading is to manually call a render function.
                // But since render logic is inside onValue, let's just reload the page for now to be safe.
                // Or better: move render logic to a separate function. (Done in previous step, but let's stick to reload for stability).
                location.reload(); 
            });
        }

        window.doTask = async function(tid, rew, link) {
            window.open(link, '_blank');
            const newBal = parseFloat(user.balance) + parseFloat(rew);
            const updates = {};
            updates['users/'+user.id+'/balance'] = newBal;
            updates['users/'+user.id+'/completed/'+tid] = true;
            await update(ref(db), updates);
            Swal.fire({toast:true, icon:'success', title:'Reward Added!', showConfirmButton:false, timer:1500});
        }

        window.transferMoney = async function() {
            const targetCard = document.getElementById('t-card').value.toString();
            const amt = parseFloat(document.getElementById('t-amt').value);

            if(!targetCard || !amt) return Swal.fire('Error', 'Fill details', 'error');
            if(amt > user.balance) return Swal.fire('Error', 'Insufficient Balance', 'error');
            if(targetCard === user.cardID) return Swal.fire('Error', 'Cannot send to self', 'error');

            Swal.showLoading();
            const q = query(ref(db, 'users'), orderByChild('cardID'), equalTo(targetCard));
            const snapshot = await get(q);

            if(snapshot.exists()) {
                let targetUid = Object.keys(snapshot.val())[0];
                let targetUser = snapshot.val()[targetUid];

                const updates = {};
                updates['users/'+user.id+'/balance'] = user.balance - amt;
                updates['users/'+targetUid+'/balance'] = parseFloat(targetUser.balance) + amt;

                await update(ref(db), updates);
                
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${targetUid}&text=ðŸ’° Received à§³${amt} from ${user.name}`);
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_ID}&text=ðŸ”„ Transfer: à§³${amt} from ${user.name} to ${targetUser.name}`);
                
                Swal.fire('Success', `Sent à§³${amt}`, 'success');
                document.getElementById('t-card').value = '';
                document.getElementById('t-amt').value = '';
            } else {
                Swal.fire('Error', 'Invalid Card ID', 'error');
            }
        }

        window.setPay = function(m, el) {
            payMethod = m;
            document.querySelectorAll('.pay-opt').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
        }

        window.withdraw = async function() {
            const num = document.getElementById('w-num').value;
            const amt = parseFloat(document.getElementById('w-amt').value);

            if(!payMethod) return Swal.fire('Error', 'Select Method', 'error');
            if(!num || !amt) return Swal.fire('Error', 'Fill all fields', 'error');
            if(amt < settings.minWithdraw) return Swal.fire('Error', 'Min Withdraw: '+settings.minWithdraw, 'error');
            if(user.refCount < settings.minRefer) return Swal.fire('Error', 'Need Refers: '+settings.minRefer, 'error');
            if(amt > user.balance) return Swal.fire('Error', 'Low Balance', 'error');

            const rid = Date.now();
            await set(ref(db, 'withdraws/'+rid), {
                id: rid, userId: user.id, userName: user.name, amount: amt, number: num, method: payMethod, status: 'pending', date: new Date().toLocaleString()
            });
            await update(ref(db, 'users/'+user.id), { balance: user.balance - amt });
            
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_ID}&text=ðŸ’¸ Withdraw Request: à§³${amt} (${payMethod}) by ${user.name}`);
            Swal.fire('Success', 'Request Sent!', 'success');
        }

        window.copyCardID = function() {
            navigator.clipboard.writeText(user.cardID);
            Swal.fire({toast:true, icon:'success', title:'Card ID Copied', showConfirmButton:false, timer:1000});
        }

        window.copyRef = function() {
            const copyText = document.getElementById("ref-link-real");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            try { document.execCommand('copy'); Swal.fire({toast:true, icon:'success', title:'Copied!', timer:1000, showConfirmButton:false}); } 
            catch (err) { navigator.clipboard.writeText(copyText.value); }
        }

        window.openSupport = function() {
            if(settings.supportLink) window.open(settings.supportLink, '_blank');
            else Swal.fire('Info', 'Support not set', 'info');
        }

        window.logout = function() {
            localStorage.removeItem('web_uid');
            location.reload();
        }

        window.editName = async function() {
            const {value:n} = await Swal.fire({title:'Edit Name', input:'text'});
            if(n) await update(ref(db, 'users/'+user.id), { name: n });
        }

        window.nav = function(page, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        init();
    </script>
</body>
</html>
